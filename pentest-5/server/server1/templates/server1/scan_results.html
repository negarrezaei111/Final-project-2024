import React, { useState, useEffect } from 'react';
import axios from 'axios';

const ScanResults = ({ scanId }) => {
  const [scan, setScan] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => {
    const fetchScanResults = async () => {
      const apiUrl = process.env.REACT_APP_API_URL || 'http://localhost:8000';
      try {
        const response = await axios.get(`${apiUrl}/scan/results/${scanId}/`);
        console.log('Received data:', response.data); // Log data for debugging

        if (response.data) {
          setScan(response.data);
        } else {
          setError('No data received from server');
        }
      } catch (err) {
        if (err.response) {
          // Server responded with a status other than 200 range
          setError(err.response.data.error || 'Error fetching scan results');
        } else if (err.request) {
          // Request was made but no response received
          setError('Network error');
        } else {
          // Something else caused the error
          setError('An unexpected error occurred');
        }
      } finally {
        setLoading(false);
      }
    };

    fetchScanResults();
  }, [scanId]);

  if (loading) {
    return <div>Loading...</div>;
  }

  if (error) {
    return <div>Error: {error}</div>;
  }

  if (!scan) {
    return <div>No scan results found for ID: {scanId}</div>;
  }

  return (
    <div>
      <h2>Scan Results</h2>
      <p>Scan ID: {scan.scan.id}</p>
      <p>Scan Date: {new Date(scan.scan.scan_date).toLocaleString()}</p>
      <h3>Vulnerabilities:</h3>
      <ul>
        {scan.scan.vulnerabilities && scan.scan.vulnerabilities.length > 0 ? (
          JSON.parse(scan.scan.vulnerabilities).map((vuln, index) => (
            <li key={index}>
              <strong>Parameter:</strong> {vuln.parameter}<br />
              <strong>Payload:</strong> {vuln.payload}<br />
              <strong>Description:</strong> {vuln.description}
            </li>
          ))
        ) : (
          <li>No vulnerabilities found</li>
        )}
      </ul>
      <a href={`/download_report/${scan.scan.id}/`} className="btn btn-primary">Download Report (PDF)</a>
    </div>
  );
};

export default ScanResults;
