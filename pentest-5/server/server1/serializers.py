
from rest_framework import serializers
from .models import Scan, VulnerabilityDetail, SubScan

class VulnerabilityDetailSerializer(serializers.ModelSerializer):
    class Meta:
        model = VulnerabilityDetail
        fields = ['parameter', 'payload', 'description', 'vuln_type', 'type']

class SubScanSerializer(serializers.ModelSerializer):
    vulnerabilities = VulnerabilityDetailSerializer(many=True, read_only=True)

    class Meta:
        model = SubScan
        fields = ['crawled_url', 'is_vulnerable', 'security_score', 'vulnerabilities']

class ScanSerializer(serializers.ModelSerializer):
    subscans = SubScanSerializer(many=True, read_only=True)

    class Meta:
        model = Scan
        fields = ['url', 'scan_date', 'is_vulnerable', 'vulnerabilities', 'security_score', 'subscans','main_url','scan_identifier']

    def create(self, validated_data):
        user = self.context['request'].user
        scan, created = Scan.objects.get_or_create(url=validated_data['url'], defaults={'user': user})
        return scan

    def to_representation(self, instance):
        representation = super().to_representation(instance)
        print("response on serializers", representation)
        return representation
