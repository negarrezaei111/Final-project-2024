from django import forms
from .models import Scan

class ScanForm(forms.ModelForm):
    class Meta:
        model = Scan
        fields = ['url']

    def clean_url(self):
        url = self.cleaned_data.get('url')
        if not url:
            raise forms.ValidationError("URL cannot be empty.")


        recent_scan = Scan.objects.filter(user=self.current_user,url=url).order_by('-scan_date').first()


        if recent_scan and not recent_scan.can_rescan():
            raise forms.ValidationError(
                "This URL was scanned recently. Please wait for at least an hour or request a new scan."
            )

        return url

    def __init__(self, *args, **kwargs):

        self.current_user = kwargs.pop('current_user', None)
        super().__init__(*args, **kwargs)
